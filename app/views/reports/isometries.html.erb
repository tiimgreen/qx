<div class="container mt-4">
  <h2>Isometries Report for <%= @project.name %></h2>

<!-- Total Progress Bar -->
<div class="card mb-4">
  <div class="card-body">
    <h5>Total Progress</h5>
    <div class="progress position-relative" style="height: 25px; background-color: #e9ecef;">
      <% total_possible = @isometries.count * (Sector::QR_SECTOR_MODELS.reject { |s| s == "isometry" }.size) %>
      <% total_completed = Sector::QR_SECTOR_MODELS.reject { |s| s == "isometry" }.sum { |sector| @isometries.count { |iso| iso.send(sector)&.completed? } } %>
      <% total_percentage = (total_completed * 100.0 / total_possible).round(2) %>
      <div class="progress-bar" role="progressbar" 
           style="width: <%= total_percentage %>%; background-color: lawngreen;">
      </div>
      <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
        <span style="color: #000; font-weight: 500;">
          <%= total_completed %>/<%= total_possible %> (<%= total_percentage %>%)
        </span>
      </div>
    </div>
  </div>
</div>

  <div class="card mb-4">
    <div class="card-body">
      <h5>Sector Progress</h5>
      <div class="row">
        <% Sector::QR_SECTOR_MODELS.reject { |s| s == "isometry" }.each do |sector| %>
          <div class="col-md-3 mb-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title"><%= t("sectors.#{sector}") %></h5>
                <div class="progress position-relative" style="height: 25px; background-color: #e9ecef;">
                  <% completed_count = @isometries.count { |iso| iso.send(sector)&.completed? } %>
                  <% completion_percentage = (completed_count * 100.0 / @isometries.count).round(2) %>
                  <div class="progress-bar" role="progressbar" 
                       style="width: <%= completion_percentage %>%; background-color: lawngreen;">
                  </div>
                  <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                    <span style="color: #000; font-weight: 500;">
                      <%= completed_count %>/<%= @isometries.count %> (<%= completion_percentage %>%)
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered" data-controller="datatable">
      <thead>
        <tr>
          <th>Line ID</th>
          <th>Page Number</th>
          <% Sector::QR_SECTOR_MODELS.reject { |s| s == "isometry" }.each do |sector| %>
            <th><%= t("sectors.#{sector}") %></th>
          <% end %>
          <th>Overall Progress</th>
        </tr>
      </thead>
      <tbody>
        <% @isometries.each do |isometry| %>
          <tr>
            <td><%= link_to isometry.line_id, project_isometry_path(@project, isometry) %></td>
            <td><%= isometry.page_number %></td>
            <% Sector::QR_SECTOR_MODELS.reject { |s| s == "isometry" }.each do |sector| %>
              <td>
                <% if sector_record = isometry.send(sector) %>
                  <% if sector_record.completed? %>
                    <span class="badge bg-success">Completed</span>
                  <% else %>
                    <span class="badge bg-warning">In Progress</span>
                  <% end %>
                <% else %>
                  <span class="badge bg-secondary">Not Started</span>
                <% end %>
              </td>
            <% end %>
            <td>
              <% completed_sectors = Sector::QR_SECTOR_MODELS.reject { |s| s == "isometry" }.count { |sector| isometry.send(sector)&.completed? } %>
              <% total_sectors = Sector::QR_SECTOR_MODELS.size - 1 %>
              <% progress = (completed_sectors * 100.0 / total_sectors).round(2) %>
              <div class="progress position-relative" style="height: 25px; background-color: #e9ecef;">
                <div class="progress-bar" role="progressbar" 
                     style="width: <%= progress %>%; background-color: lawngreen;">
                </div>
                <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                  <span style="color: #000; font-weight: 500; font-size: 0.8rem;">
                    (<%= progress %>%)
                  </span>
                </div>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
