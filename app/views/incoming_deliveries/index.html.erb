<%= render 'breadcrumb', breadcrumbs: [
  { text: @project.name, path: project_path(@project) },
  { text: t('navigation.menu.incoming_deliveries.title'),
    path: project_incoming_deliveries_path(@project) }
] %>

<div class="mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-white"><%= t('.title_for_project', project: @project.name) %></h1>
  </div>

  <div class="row mb-4">
    <div class="col-md-8">
      <%= form_tag project_incoming_deliveries_path(@project), method: :get do %>
        <div class="input-group">
          <%= text_field_tag :search, params[:search],
                            class: 'form-control',
                            placeholder: t('common.labels.search_placeholder') %>
          <div class="input-group-append">
            <%= submit_tag t('common.labels.search_button'), class: 'btn btn-primary m-1' %>
          </div>
        </div>
      <% end %>
    </div>
    <div class="col-md-4 text-end">
      <% if current_user.can_create?("IncomingDelivery") && !current_user.has_pending_deliveries?("IncomingDelivery", @project.id) %>
        <%= link_to new_project_incoming_delivery_path(@project), class: 'btn btn-primary' do %>
          <i class="bi bi-plus"></i> <%= t('incoming_deliveries.buttons.new_delivery') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover table-sm">
        <thead>
          <tr>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.work_location'),
                  request.params.merge(sort: 'work_location_id', direction: (params[:sort] == 'work_location_id' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('work_location_id') %>
            </th>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.delivery_note_number'),
                  request.params.merge(sort: 'delivery_note_number', direction: (params[:sort] == 'delivery_note_number' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('delivery_note_number') %>
            </th>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.order_number'),
                  request.params.merge(sort: 'order_number', direction: (params[:sort] == 'order_number' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('order_number') %>
            </th>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.delivery_date'),
                  request.params.merge(sort: 'delivery_date', direction: (params[:sort] == 'delivery_date' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('delivery_date') %>
            </th>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.supplier_name'),
                  request.params.merge(sort: 'supplier_name', direction: (params[:sort] == 'supplier_name' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('supplier_name') %>
            </th>
            <th>
              <%= link_to t('.items_count'),
                  request.params.merge(sort: 'delivery_items_count', direction: (params[:sort] == 'delivery_items_count' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('delivery_items_count') %>
            </th>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.on_hold_status'),
                  request.params.merge(sort: 'on_hold_status', direction: (params[:sort] == 'on_hold_status' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('on_hold_status') %>
            </th>
            <th>
              <%= link_to t('activerecord.attributes.incoming_delivery.completed'),
                  request.params.merge(sort: 'completed', direction: (params[:sort] == 'completed' && params[:direction] == 'asc') ? 'desc' : 'asc') %>
              <%= sort_indicator('completed') %>
            </th>
            <th><%= t('activerecord.attributes.incoming_delivery.created_by') %></th>
            <th class="text-end"><%= t('common.labels.actions') %></th>
          </tr>
        </thead>

        <tbody>
          <% @incoming_deliveries.each do |delivery| %>
            <tr>
              <td><%= t("work_locations.types.#{delivery.work_location.location_type}") %></td>
              <td><%= delivery.delivery_note_number %></td>
              <td><%= link_to delivery.order_number, project_incoming_delivery_path(@project, delivery) %></td>
              <td><%= delivery.delivery_date.strftime("%d/%m/%Y") %></td>
              <td><%= delivery.supplier_name %></td>
              <td><%= delivery.delivery_items.count %></td>
              <td><%= status_label(delivery.on_hold_status) %></td>
              <td><%= status_label(delivery.completed ? t('common.yes') : t('common.no')) %></td>
              <td><%= delivery.user&.name %></td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <% if current_user.can_view?("IncomingDelivery") %>
                    <%= link_to project_incoming_delivery_path(@project, delivery),
                               class: 'btn btn-outline-info m-1',
                               title: t('incoming_deliveries.buttons.view'),
                               data: { bs_toggle: 'tooltip' } do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                  <% end %>

                  <% if current_user.can_edit?("IncomingDelivery") %>
                    <%= link_to edit_project_incoming_delivery_path(@project, delivery),
                               class: 'btn btn-outline-primary m-1',
                               title: t('incoming_deliveries.buttons.edit'),
                               data: { bs_toggle: 'tooltip' } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                  <% end %>

                  <% if current_user.can_delete?("IncomingDelivery") %>
                    <%= button_tag type: 'button',
                               class: 'btn btn-outline-danger m-1',
                               title: t('incoming_deliveries.buttons.delete'),
                               data: {
                                 bs_toggle: "modal",
                                 bs_target: "#deleteIncomingDeliveryModal",
                                 incoming_delivery_id: delivery.id,
                                 project_id: @project.id,
                                 incoming_delivery_name: delivery.order_number,
                                 incoming_delivery_number: delivery.delivery_note_number
                               } do %>
                      <i class="bi bi-trash"></i>
                    <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
  </div>
</div>

<%= render partial: 'delete_confirmation_modal', 
           locals: {
             modal_id: 'deleteIncomingDeliveryModal',
             controller_name: 'delete-incoming-delivery',
             model_name: 'incoming_delivery'
           } %>

<%= render 'pagy' %>    