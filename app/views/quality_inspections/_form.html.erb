<%= form_with(model: [@delivery_item, @quality_inspection].compact,
    local: true,
    class: 'needs-validation',
    html: { multipart: true }) do |f| %>

  <% if @quality_inspection.errors.any? %>
    <div class="alert alert-danger">
      <h6><%= pluralize(@quality_inspection.errors.count, "error") %> prohibited this inspection from being saved:</h6>
      <ul>
        <% @quality_inspection.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :inspection_type, class: 'form-label required' %>
        <%= f.select :inspection_type,
            QualityInspection.inspection_types.keys.map { |t| [t.titleize, t] },
            { prompt: t('.select_type') },
            { class: 'form-select', required: true } %>
      </div>

      <div class="mb-3">
        <%= f.label :inspector_name, class: 'form-label required' %>
        <%= f.text_field :inspector_name, class: 'form-control', required: true %>
      </div>

      <div class="mb-3">
        <%= f.label :inspection_date, class: 'form-label required' %>
        <%= f.datetime_local_field :inspection_date,
            class: 'form-control',
            required: true,
            value: @quality_inspection.inspection_date&.strftime('%Y-%m-%dT%H:%M') || Time.current.strftime('%Y-%m-%dT%H:%M') %>
      </div>
    </div>

    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :status, class: 'form-label required' %>
        <%= f.select :status,
            [['Passed', 'passed'], ['Failed', 'failed']],
            { prompt: t('.select_status') },
            { class: 'form-select', required: true } %>
      </div>

      <div class="mb-3">
        <%= f.label :notes, class: 'form-label' %>
        <%= f.text_area :notes, class: 'form-control', rows: 3 %>
      </div>
    </div>
  </div>
  <!-- Add this before the inspection defects card -->
  <div class="card mt-4">
    <div class="card-header">
      <h6 class="mb-0"><%= t('.inspection_images') %></h6>
    </div>
    <div class="card-body" data-controller="image-preview">
      <% if @quality_inspection.images.attached? %>
        <div class="row mb-3">
          <% @quality_inspection.images.each do |image| %>
            <div class="col-md-3 mb-3">
              <%= image_tag image, class: "img-thumbnail mb-2", style: "max-height: 150px; width: auto;" %>
              <div>
                <%= link_to t('.remove_image'),
                    remove_image_quality_inspection_path(@quality_inspection, image_id: image.id),
                    class: "btn btn-danger btn-sm",
                    data: {
                      turbo_method: :delete,
                      turbo_confirm: t('.confirm_remove_image')
                    } %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <div class="mb-3">
        <%= f.label :images, class: 'form-label' %>
        <%= f.file_field :images,
            multiple: true,
            accept: 'image/png,image/jpeg,image/jpg',
            class: 'form-control',
            data: { action: "change->image-preview#preview" } %>
        <div class="form-text">
          <%= t('.image_help_text') %>
        </div>
        <div data-image-preview-target="preview" class="row mt-2">
          <!-- Preview images will be inserted here -->
        </div>
      </div>
    </div>
  </div>
  <div class="card mt-4">
    <div class="card-header">
      <h6 class="mb-0"><%= t('.inspection_defects') %></h6>
    </div>
    <div class="card-body">
      <div data-controller="nested-form">
        <!-- Template for new defect fields -->
        <template data-nested-form-target="template">
          <%= f.fields_for :inspection_defects, InspectionDefect.new, child_index: 'NEW_RECORD' do |defect_form| %>
            <%= render 'inspection_defect_fields', f: defect_form %>
          <% end %>
        </template>

        <!-- Existing defect fields -->
        <div data-nested-form-target="fields">
          <%= f.fields_for :inspection_defects do |defect_form| %>
            <%= render 'inspection_defect_fields', f: defect_form %>
          <% end %>
        </div>

        <%= link_to t('.add_defect'), "#",
            class: "btn btn-outline-primary btn-sm mt-3",
            data: { action: "click->nested-form#add" } %>
      </div>
    </div>
  </div>

  <div class="form-actions mt-4">
    <%= f.submit class: 'btn btn-primary' %>
    <%= link_to t('common.cancel'), :back, class: 'btn btn-secondary' %>
  </div>
<% end %>