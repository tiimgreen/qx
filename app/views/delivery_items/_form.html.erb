<%= form_with(model: [@incoming_delivery, @delivery_item].compact, local: true, class: 'needs-validation') do |f| %>
  <% if @delivery_item.errors.any? %>
    <div class="alert alert-danger">
      <h6><%= t('delivery_items.form.errors.header', count: @delivery_item.errors.count) %></h6>
      <ul>
        <% @delivery_item.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :tag_number, t('activerecord.attributes.delivery_item.tag_number'), class: 'form-label' %>
        <%= f.text_field :tag_number, class: 'form-control' %>
      </div>

      <div class="mb-3">
        <%= f.label :batch_number, t('activerecord.attributes.delivery_item.batch_number'), class: 'form-label' %>
        <%= f.text_field :batch_number, class: 'form-control' %>
      </div>

      <div class="mb-3">
        <%= f.label :quantity_received, t('activerecord.attributes.delivery_item.quantity_received'), class: 'form-label' %>
        <%= f.number_field :quantity_received, class: 'form-control' %>
      </div>
    </div>

    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :item_description, t('activerecord.attributes.delivery_item.item_description'), class: 'form-label' %>
        <%= f.text_area :item_description, class: 'form-control', rows: 3 %>
      </div>

      <div class="mb-3">
        <label class="form-label"><%= t('.specifications') %></label>
        <div class="specifications-fields">
          <div class="specification-entries">
            <% (@delivery_item.specifications || {}).each do |key, value| %>
              <div class="specification-entry mb-2">
                <div class="input-group">
                  <input type="text"
                         name="delivery_item[specifications][<%= key %>]"
                         value="<%= value %>"
                         class="form-control"
                         placeholder="<%= t('.value_placeholder') %>">
                  <button type="button" class="btn btn-outline-danger m-1 remove-specification">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>
            <% end %>
          </div>
          <button type="button" class="btn btn-outline-secondary m-1 btn-sm add-specification">
            <i class="bi bi-plus"></i> <%= t('.add_specification') %>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit t('.submit'), class: 'btn btn-primary' %>
    <%= link_to t('.cancel'), :back, class: 'btn btn-secondary' %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.specification-entries');
    const addButton = document.querySelector('.add-specification');

    addButton.addEventListener('click', function() {
      const newKey = Date.now().toString().substr(-6);
      const newEntry = document.createElement('div');
      newEntry.className = 'specification-entry mb-2';
      newEntry.innerHTML = `
        <div class="input-group">
          <input type="text" name="delivery_item[specifications][spec_${newKey}]" class="form-control" placeholder="Value">
          <button type="button" class="btn btn-outline-danger m-1 remove-specification">&times;</button>
        </div>
      `;
      container.appendChild(newEntry);
    });

    // Event delegation for remove buttons
    container.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-specification')) {
        e.target.closest('.specification-entry').remove();
      }
    });
  });
</script>