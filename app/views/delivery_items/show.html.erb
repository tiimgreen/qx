<%= render 'breadcrumb', breadcrumbs: [
  { text: @project.name, path: project_path(@project) },
  { text: t('navigation.menu.incoming_deliveries.deliveries.title'),
    path: project_incoming_deliveries_path(@project) },
  { text: @incoming_delivery.order_number,
    path: project_incoming_delivery_path(@project, @incoming_delivery) },
  { text: @delivery_item.delivery_note_position || @delivery_item.tag_number }
] %>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><%= t('.title') %></h5>
    <div class="btn-group btn-group-sm">
      <% if !@project.archived? %>
      <%= link_to edit_project_incoming_delivery_delivery_item_path(@delivery_item.incoming_delivery.project, @delivery_item.incoming_delivery, @delivery_item),
                  class: 'btn btn-outline-primary m-1 text-white',
                  title: t('delivery_items.buttons.edit'),
                  data: { bs_toggle: 'tooltip' } do %>
        <i class="bi bi-pencil"></i>
      <% end %>
      <% end %>
      <%= link_to project_incoming_delivery_path(@delivery_item.incoming_delivery.project, @delivery_item.incoming_delivery),
                  class: 'btn btn-primary m-1',
                  title: t('delivery_items.buttons.back'),
                  data: { bs_toggle: 'tooltip' } do %>
        <i class="bi bi-arrow-left"></i>
      <% end %>
    </div>
  </div>

  <div class="card-body">
    <!-- Basic Information -->
    <div class="row">
      <div class="col-md-6">
        <div class="mb-4">
          <h5 class="border-bottom pb-2 mb-3"><%= t('.basic_info') %></h5>
          <dl class="row">
            <dt class="col-sm-4"><%= t('activerecord.attributes.delivery_item.delivery_note_position') %></dt>
            <dd class="col-sm-8"><%= @delivery_item.delivery_note_position %></dd>

            <dt class="col-sm-4"><%= t('activerecord.attributes.delivery_item.tag_number') %></dt>
            <dd class="col-sm-8"><%= @delivery_item.tag_number %></dd>

            <dt class="col-sm-4"><%= t('activerecord.attributes.delivery_item.batch_number') %></dt>
            <dd class="col-sm-8"><%= @delivery_item.batch_number %></dd>

            <dt class="col-sm-4"><%= t('activerecord.attributes.delivery_item.created_by') %></dt>
            <dd class="col-sm-8"><%= @delivery_item.user&.name %></dd>

            <dt class="col-sm-4"><%= t('common.completed') %></dt>
            <dd class="col-sm-8"><%= status_label(@delivery_item.completed? ? t('common.yes') : t('common.no')) %></dd>
          </dl>
        </div>
      </div>
      <div class="col-md-6">
          <!-- Description -->
        <div class="mb-4">
          <h5 class="border-bottom pb-2 mb-3"><%= t('.description') %></h5>
          <p class="mb-0"><%= @delivery_item.item_description %></p>
        </div>
      </div>
    </div>

<!-- Quality Checks -->
<div class="mb-4">
  <h5 class="border-bottom pb-2 mb-3"><%= t('.quality_checks') %></h5>

  <% checks = [
    { name: 'quantity_check', status: @delivery_item.quantity_check_status, comment: @delivery_item.quantity_check_comment, images: @delivery_item.quantity_check_images },
    { name: 'dimension_check', status: @delivery_item.dimension_check_status, comment: @delivery_item.dimension_check_comment, images: @delivery_item.dimension_check_images },
    { name: 'visual_check', status: @delivery_item.visual_check_status, comment: @delivery_item.visual_check_comment, images: @delivery_item.visual_check_images },
    { name: 'vt2_check', status: @delivery_item.vt2_check_status, comment: @delivery_item.vt2_check_comment, images: @delivery_item.vt2_check_images },
    {
      name: 'ra_check',
      status: @delivery_item.ra_check_status,
      comment: @delivery_item.ra_check_comment,
      images: @delivery_item.ra_check_images,
      additional_fields: {
        ra_date: @delivery_item.ra_date ? @delivery_item.ra_date&.strftime("%Y-%m-%d") : nil,
        ra_value: @delivery_item.ra_value,
        ra_parameters: @delivery_item.ra_parameters
      }
    },
    { name: 'on_hold', status: @delivery_item.on_hold_status, comment: @delivery_item.on_hold_comment, date: @delivery_item.on_hold_date, images: @delivery_item.on_hold_images }
  ] %>

  <div class="row g-3">
    <% checks.each do |check| %>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title d-flex justify-content-between align-items-center">
              <%= t("activerecord.attributes.delivery_item.#{check[:name]}") %>
              <%= status_label(check[:status]) %>
            </h6>


            <% if check[:additional_fields].present? %>
              <div class="mt-3">
                <% check[:additional_fields].each do |field, value| %>
                  <% if value.present? %>
                    <div class="d-flex justify-content-between">
                      <small class="text-muted"><%= t("activerecord.attributes.delivery_item.#{field}") %>:</small>
                      <small><%= value %></small>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>

            
            <p class="card-text text-muted mb-0">
              <% if check[:comment].present? %>
                  <small><b><%= t('common.messages.on_hold_comment') %></b>: <%= check[:comment] %></small><br>
              <% end %>
              <% if check[:date].present? %>
                  <small><b><%= t('common.messages.on_hold_at') %></b>: <%= check[:date].strftime("%d/%m/%Y %H:%M") %></small>
              <% end %>
            </p>

            <%= render 'application/docuvita_documents', documents: check[:images] %>

          </div>
        </div>
      </div>
    <% end %>
    </div>
  </div>

  </div>
</div>
