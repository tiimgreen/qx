<%# Form with navigation warning and autosave %>
<div data-controller="form-navigation">
  <%= form_with(model: [@project, @isometry],
                local: true,
                class: "needs-validation",
                data: {
                  controller: "autosave",
                  autosave_interval_value: 300000,
                  form_navigation_target: "form"
                }) do |f| %>
  <% if @isometry.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= t('common.messages.errors', count: @isometry.errors.count) %></h4>
      <ul>
        <% @isometry.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

<div class="accordion" id="mainAccordion">
  <!-- Technical Specification -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section1">
        <%= t('.technical_specs') %>
      </button>
    </h2>
    <div id="section1" class="accordion-collapse collapse show" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="row">
                <div class="col-md-2 mb-3">
                  <%= f.label :pid_number, class: "form-label" %>
                  <%= f.text_field :pid_number, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :pid_revision, class: "form-label" %>
                  <%= f.number_field :pid_revision, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :line_id, class: "form-label" %>
                  <%= f.text_field :line_id, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :dn, class: "form-label" %>
                  <%= f.text_field :dn, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :revision_number, class: "form-label" %>
                  <%= f.number_field :revision_number, class: "form-control", min: 0, max: 10 %>
                </div>

                <% if @project.workshop? %>
                  <div class="col-md-2 mb-3">
                    <%= f.label :revision_letter, class: "form-label" %>
                    <%= f.text_field :revision_letter, class: "form-control" %>
                  </div>
                <% end %>

                <div class="col-md-2 mt-3">
                  <%= f.check_box :revision_last, class: "form-check-input" %>
                  <%= f.label :revision_last, class: "form-check-label" %>
                </div>
              </div>

              <div class="row">
                <div class="col-md-2 mb-3">
                  <%= f.label :page_number, class: "form-label" %>
                  <%= f.number_field :page_number, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :page_total, class: "form-label" %>
                  <%= f.number_field :page_total, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :pipe_class, class: "form-label" %>
                  <%= f.text_field :pipe_class, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :material, class: "form-label" %>
                  <%= f.text_field :material, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :system, class: "form-label" %>
                  <%= f.text_field :system, class: "form-control" %>
                </div>

                <div class="col-md-2 mb-3">
                  <%= f.label :medium, class: "form-label" %>
                  <%= f.text_field :medium, class: "form-control" %>
                </div>
              </div>

              <div class="row">
                <div class="col-md-2 mb-3">
                  <%= f.label :work_package_number, class: "form-label" %>
                  <%= f.number_field :work_package_number, class: "form-control" %>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Additional Specification -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section2">
        <%= t('.additional_specs') %>
      </button>
    </h2>
    <div id="section2" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="container p-4">

                <div class="row mb-3">
                  <div class="col-md-2 mb-3">
                    <%= f.label :ped_category, class: "form-label mb-0" %>
                    <div class="flex-grow-1 ms-3">
                      <%= f.select :ped_category, Isometry::PED_CATEGORIES, { include_blank: true }, class: "form-select" %>
                    </div>
                  </div>

                  <div class="col-md-2 mb-3">
                    <label class="form-label mb-0"><%= t('.slope') %></label>
                    <div class="flex-grow-1 ms-3">
                      <div class="input-group">
                        <%= f.text_field :slope_if_needed, class: "form-control", step: "1" %>
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label mb-0"><%= t('.isometry_rt') %></label>
                    <div class="flex-grow-1 ms-3">
                      <div class="input-group">
                        <%= f.number_field :rt, class: "form-control", step: "1" %>
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label mb-0"><%= t('.isometry_vt') %></label>
                    <div class="flex-grow-1 ms-3">
                      <div class="input-group">
                        <%= f.number_field :vt2, class: "form-control", step: "1" %>
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label mb-0"><%= t('.isometry_vt_pictures') %></label>
                    <div class="flex-grow-1 ms-3">
                      <div class="input-group">
                        <%= f.number_field :vt_pictures, class: "form-control", step: "1" %>
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label mb-0"><%= t('.isometry_pt') %></label>
                    <div class="flex-grow-1 ms-3">
                      <div class="input-group">
                        <%= f.number_field :pt2, class: "form-control", step: "1" %>
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-1 mb-3">
                    <%= f.label :dp, class: "form-label mb-0" %>
                    <%= f.check_box :dp, class: "form-check-input mt-0" %>
                  </div>
                  <div class="col-md-1 mb-3">
                    <%= f.label :dip, class: "form-label mb-0" %>
                    <%= f.check_box :dip, class: "form-check-input mt-0" %>
                  </div>

                  <div class="col-md-1 mb-3">
                    <%= f.label :gmp, class: "form-label mb-0" %>
                    <%= f.check_box :gmp, class: "form-check-input mt-0" %>
                  </div>
                  <div class="col-md-1 mb-3">
                    <%= f.label :gdp, class: "form-label mb-0" %>
                    <%= f.check_box :gdp, class: "form-check-input mt-0" %>
                  </div>

                  <div class="col-md-2 mb-3">
                    <%= f.label :isolation_required, class: "form-label mb-0" %>
                    <%= f.check_box :isolation_required, class: "form-check-input mt-0" %>
                  </div>

                  <div class="col-md-4 mb-3">
                    <%= f.label :approved_for_production, class: "form-label mb-0" %>
                    <%= f.check_box :approved_for_production, class: "form-check-input mt-0" %>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inspection -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section3">
        <%= t('.inspection') %>
      </button>
    </h2>
    <div id="section3" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="row g-3">
          <div class="card mb-4">
            <div class="card-body">
              <div class="row">
                <dt><%= f.label :rt_percentage %></dt>
                <%= f.file_field :rt_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff,application/pdf,application/pdf', class: "form-control my-2 w-100 w-md-50" %>
                <%= render partial: 'docuvita_documents', locals: {
                  documents: @isometry.rt_images,
                  edit_mode: true,
                  title: t('.rt_images')
                } %>
              </div>

              <div class="row">
                <dt><%= f.label :vt2_percentage %></dt>
                <%= f.file_field :vt_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff,application/pdf,application/pdf', class: "form-control my-2 w-100 w-md-50" %>
                <%= render partial: 'docuvita_documents', locals: {
                  documents: @isometry.vt_images,
                  edit_mode: true,
                  title: t('.vt_images')
                } %>
              </div>

              <div class="row">
                <dt><%= f.label :vt_pictures_percentage %></dt>
                <%= f.file_field :vt_pictures_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff,application/pdf,application/pdf', class: "form-control my-2 w-100 w-md-50" %>
                <%= render partial: 'docuvita_documents', locals: {
                  documents: @isometry.vt_pictures_images,
                  edit_mode: true,
                  title: t('.vt_pictures_images')
                } %>
              </div>

              <div class="row">
                <dt><%= f.label :pt2_percentage %></dt>
                <%= f.file_field :pt_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff,application/pdf,application/pdf', class: "form-control my-2 w-100 w-md-50" %>
                <%= render partial: 'docuvita_documents', locals: {
                  documents: @isometry.pt_images,
                  edit_mode: true,
                  title: t('.pt_images')
                } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Spooling -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section4">
        <%= t('.spooling') %>
      </button>
    </h2>
    <div id="section4" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
          <div class="row g-3">
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-2 mb-3">
                    <%= f.label :pipe_length, class: "form-label" %>
                    <div class="input-group">
                      <%= f.number_field :pipe_length, class: "form-control", step: "0.01" %>
                      <span class="input-group-text">M</span>
                    </div>
                  </div>
                  <div class="col-md-2 mb-3">
                    <%= f.label :workshop_sn, class: "form-label" %>
                    <div class="input-group">
                      <%= f.number_field :workshop_sn, class: "form-control" %>
                      <span class="input-group-text">PCS</span>
                    </div>
                  </div>

                  <div class="col-md-2 mb-3">
                    <%= f.label :on_site_sn, class: "form-label" %>
                    <div class="input-group">
                      <%= f.number_field :assembly_sn, class: "form-control" %>
                      <span class="input-group-text">PCS</span>
                    </div>
                  </div>

                  <div class="col-md-2 mb-3">
                    <%= f.label :total_sn, class: "form-label" %>
                    <div class="input-group">
                      <%= f.number_field :total_sn, class: "form-control" %>
                      <span class="input-group-text">PCS</span>
                    </div>
                  </div>

                  <div class="col-md-2 mb-3">
                    <%= f.label :total_supports, class: "form-label" %>
                    <div class="input-group">
                      <%= f.number_field :total_supports, class: "form-control" %>
                      <span class="input-group-text">PCS</span>
                    </div>
                  </div>
                  <div class="col-md-2 mb-3">
                    <%= f.label :total_spools, class: "form-label" %>
                    <div class="input-group">
                      <%= f.number_field :total_spools, class: "form-control" %>
                      <span class="input-group-text">PCS</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

      </div>
    </div>
  </div>

  <!-- On hold status -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section5">
        <%= t('.on_hold_status') %>
      </button>
    </h2>
    <div id="section5" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="row g-3">

          <%= render 'hold_fields', f: f, delete_path: ->(image) {
            delete_image_project_isometry_path(@project, @isometry, image_id: image)
          } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Weldings -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section6">
        <%= t('.weldings') %>
      </button>
    </h2>
    <div id="section6" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
      <!-- NEW: additional empty-row count -->
      <div class="row g-3 mb-3">
        <div class="col-md-2">
          <%= f.label :additional_empty_rows,
                      t('isometries.form.additional_empty_rows', default: 'Additional empty rows'),
                      class: 'form-label' %>
          <%= f.number_field :additional_empty_rows, min: 0, step: 1, class: 'form-control' %>
        </div>
      </div>
        <div class="card mb-4">
          <div class="card-body" data-controller="nested-form">
            <template data-nested-form-target="template">
              <%= f.fields_for :weldings, Welding.new, child_index: 'NEW_RECORD' do |welding| %>
                <%= render 'weldings/welding_fields', f: welding %>
              <% end %>
            </template>

            <div data-nested-form-target="fields">
              <%= f.fields_for :weldings do |welding| %>
                <%= render 'weldings/welding_fields', f: welding %>
              <% end %>
            </div>

            <div class="mt-3">
              <%= link_to t('common.add_welding'), '#',
                  class: "btn btn-primary",
                  data: { action: "click->nested-form#add" } %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Material Certificates -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section7">
        <%= t('.material_certificates') %>
      </button>
    </h2>
    <div id="section7" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="card mb-4" data-controller="material-certificate-search"
            data-project-id="<%= @project.id %>"
            data-isometry-id="<%= @isometry.id %>">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label"><%= t('.search_certificates') %></label>
                  <%= text_field_tag :search, nil,
                    class: "form-control",
                    data: {
                      material_certificate_search_target: "search",
                      action: "input->material-certificate-search#search",
                      material_certificate_search_url: search_material_certificates_path
                    },
                    placeholder: t('.search_certificates_placeholder'),
                    autocomplete: "off"
                  %>
                </div>
                <div id="certificate-results"
                    class="list-group mb-3"
                    data-material-certificate-search-target="results"></div>
                <div class="row g-3" data-material-certificate-search-target="selected">
                  <% @isometry.material_certificates.each do |cert| %>
                    <div class="col-md-2">
                      <div class="selected-certificate" data-certificate-id="<%= cert.id %>">
                        <input type="hidden" name="isometry[material_certificate_ids][]" value="<%= cert.id %>">
                        <div class="d-flex flex-column position-relative border rounded p-2">
                          <button type="button"
                                  class="btn btn-sm btn-danger remove-certificate position-absolute top-0 end-0 m-1"
                                  data-action="click->material-certificate-search#removeCertificate">×</button>
                          <% docuvita_doc = cert.docuvita_documents.find { |doc| doc.document_type == 'material_certificate' } %>
                          <% if docuvita_doc %>
                            <%= link_to view_docuvita_document_path(docuvita_doc), target: "_blank",
                                        class: "text-decoration-none text-dark" do %>
                              <div class="text-center mb-2">
                                <i class="bi bi-file-pdf text-danger" style="font-size: 2rem;"></i>
                              </div>
                              <div class="small">
                                <%= cert.certificate_number %>
                              </div>
                            <% end %>
                          <% else %>
                            <div class="text-center mb-2">
                              <i class="bi bi-file-pdf text-danger" style="font-size: 2rem; opacity: 0.5;"></i>
                            </div>
                            <div class="small">
                              <%= cert.certificate_number %> <br>
                              <span class="text-muted">(No document)</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Isometry Documents -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section8">
        <%= t('.isometry_documents') %>
      </button>
    </h2>
    <div id="section8" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="card mb-4">
          <div class="card-body">
            <!-- Image Upload -->
            <div class="row g-3">
              <!-- Initial PDF Upload -->
              <div class="col-md-8 mb-3">
                <div class="row">
                  <div class="col-md-8">
                    <%= f.label :new_pdf, t('.upload_new_pdf'), class: "form-label" %>
                    <%= f.file_field :new_pdf, accept: 'application/pdf', class: "form-control" %>
                  </div>

                  <div class="col-md-4">
                    <%= f.label :new_pdf_qr_position, t('.qr_position'), class: "form-label" %>
                    <%= f.select :new_pdf_qr_position,
                              [
                                [t('common.labels.top_left'), "top_left"],
                                [t('common.labels.top_right'), "top_right"],
                                [t('common.labels.bottom_left'), "bottom_left"],
                                [t('common.labels.bottom_right'), "bottom_right"]
                              ],
                              { include_blank: true },
                              class: "form-select" %>
                  </div>
                </div>
              </div>

              <!-- Existing PDFs with QR Position Selection -->
              <% if @isometry.persisted? && @isometry.isometry_pdfs.any? %>
                <div class="col-12">
                  <h6 class="mb-3"><%= t('.existing_documents') %></h6>

                  <% @isometry.isometry_pdfs.each do |document| %>
                    <div class="card mb-3">
                      <div class="card-body">
                        <div class="row align-items-center">
                          <div class="col-md-1 text-center">
                            <i class="bi bi-file-pdf text-danger" style="font-size: 2rem;"></i>
                          </div>
                          <div class="col-md-4">
                            <h6 class="mb-1"><%= document.filename %></h6>
                            <small class="text-muted">
                              <%= number_to_human_size(document.byte_size) %> •
                              <%= l(document.created_at, format: :short) if document.created_at.present? %>
                            </small>
                          </div>
                          <div class="col-md-3 text-end">
                            <% if document.persisted? %>
                              <%= link_to view_docuvita_document_path(document),
                                            target: "_blank",
                                            class: "btn btn-outline-primary btn-sm me-2" do %>
                                <i class="bi bi-eye"></i> <%= t('.view') %>
                              <% end %>
                            <% end %>
                          <% if current_user.can_delete?("Isometry") %>  
                            <%= button_tag type: 'button',
                                         class: 'btn btn-outline-danger btn-sm',
                                         data: {
                                           bs_toggle: "modal",
                                           bs_target: "#deleteDocumentModal",
                                           "document-id": document.id,
                                           "document-name": document.filename,
                                           "document-number": document.docuvita_object_id
                                         } do %>
                              <i class="bi bi-trash"></i> <%= t('.delete') %>
                            <% end %>
                          <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#section9">
        <%= t('.notes') %>
      </button>
    </h2>
    <div id="section9" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body">
        <div class="card mb-4">
          <div class="card-body">
            <!-- Notes -->
            <div class="row g-3">
              <div class="mb-3">
                <%= f.text_area :notes, class: "form-control", rows: 6 %>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Submit Buttons -->
  <div class="form-group my-5 d-flex justify-content-end gap-2">
    <%= link_to t('common.actions.cancel'), :back, class: 'btn btn-secondary btn-lg' %>
    <%= f.submit t("common.actions.save"), class: "btn btn-primary btn-lg" %>
  </div>

</div>

</div>
<%= render partial: 'delete_confirmation_modal',
           locals: {
             modal_id: 'deleteDocumentModal',
             controller_name: 'delete-document',
             model_name: 'docuvita_document'
           } %>
<% end %>
</div>
