<%= form_with(model: [@project, @isometry], local: true, class: "needs-validation") do |f| %>
  <% if @isometry.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= t('common.messages.errors', count: @isometry.errors.count) %></h4>
      <ul>
        <% @isometry.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- Basic Information -->
    <div class="col-md-6 my-5">
      <h5 class="border-bottom pb-2 mb-3"><%= t('.basic_info') %></h5>

      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label :received_date, class: "form-label" %>
          <%= f.date_field :received_date, class: "form-control", value: Date.current %>
        </div>

        <div class="col-md-4 mb-3">
          <%= f.label :pid_number, class: "form-label" %>
          <%= f.text_field :pid_number, class: "form-control" %>
        </div>

        <div class="col-md-4 mb-3">
          <%= f.label :pid_revision, class: "form-label" %>
          <%= f.number_field :pid_revision, class: "form-control" %>
        </div>
      </div>

      <div class="row align-items-end">
        <div class="col-md-4 mb-3">
          <%= f.label :ped_category, class: "form-label" %>
          <%= f.select :ped_category, Isometry::PED_CATEGORIES, { include_blank: true }, class: "form-select" %>
        </div>
        <div class="col-md-8 mb-3 d-flex align-items-center">
          <div class="form-check form-check-inline mb-0">
            <%= f.check_box :gmp, class: "form-check-input" %>
            <%= f.label :gmp, class: "form-check-label" %>
          </div>
          <div class="form-check form-check-inline mb-0">
            <%= f.check_box :gdp, class: "form-check-input" %>
            <%= f.label :gdp, class: "form-check-label" %>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :pipe_class, class: "form-label" %>
          <%= f.text_field :pipe_class, class: "form-control" %>
        </div>

        <div class="col-md-6 mb-3">
          <%= f.label :material, class: "form-label" %>
          <%= f.text_field :material, class: "form-control" %>
        </div>
      </div>

      <div class="mb-3">
        <%= f.label :system, class: "form-label" %>
        <%= f.text_field :system, class: "form-control" %>
      </div>
    </div>

    <!-- Technical Specifications -->
    <div class="col-md-6 my-5">
      <h5 class="border-bottom pb-2 mb-3"><%= t('.technical_specs') %></h5>

      <div class="mb-3">
        <%= f.label :line_id, class: "form-label" %>
        <%= f.text_field :line_id, class: "form-control" %>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">
          <%= f.label :revision_number, class: "form-label" %>
          <%= f.number_field :revision_number, class: "form-control" %>
        </div>
        <div class="col-md-3 mb-3">
          <div class="form-check mt-4">
            <%= f.check_box :revision_last, class: "form-check-input" %>
            <%= f.label :revision_last, class: "form-check-label" %>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <%= f.label :page_number, class: "form-label" %>
          <%= f.number_field :page_number, class: "form-control" %>
        </div>
        <div class="col-md-3 mb-3">
          <%= f.label :page_total, class: "form-label" %>
          <%= f.number_field :page_total, class: "form-control" %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label :dn1, class: "form-label" %>
          <%= f.text_field :dn1, class: "form-control" %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :dn2, class: "form-label" %>
          <%= f.text_field :dn2, class: "form-control" %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :dn3, class: "form-label" %>
          <%= f.text_field :dn3, class: "form-control" %>
        </div>
      </div>

      <div class="mb-3">
        <%= f.label :medium, class: "form-label" %>
        <%= f.text_field :medium, class: "form-control" %>
      </div>
    </div>

    <!-- Measurements -->
    <div class="col-md-6 my-5">
      <h5 class="border-bottom pb-2 mb-3"><%= t('.measurements') %></h5>

      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label :pipe_length, class: "form-label" %>
          <%= f.number_field :pipe_length, class: "form-control", step: "0.01" %>
        </div>

        <div class="col-md-4 mb-3">
          <%= f.label :workshop_sn, class: "form-label" %>
          <%= f.number_field :workshop_sn, class: "form-control" %>
        </div>

        <div class="col-md-4 mb-3">
          <%= f.label :assembly_sn, class: "form-label" %>
          <%= f.number_field :assembly_sn, class: "form-control" %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :total_supports, class: "form-label" %>
          <%= f.number_field :total_supports, class: "form-control" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :total_spools, class: "form-label" %>
          <%= f.number_field :total_spools, class: "form-control" %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label :rt, class: "form-label" %>
          <%= f.number_field :rt, class: "form-control", step: "0.1" %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :vt2, class: "form-label" %>
          <%= f.number_field :vt2, class: "form-control", step: "0.1" %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :pt2, class: "form-label" %>
          <%= f.number_field :pt2, class: "form-control", step: "0.1" %>
        </div>
      </div>
    </div>

    <!-- Additional Specifications -->
    <div class="col-md-6 my-5">
      <h5 class="border-bottom pb-2 mb-3"><%= t('.additional_specs') %></h5>

      <div class="mb-3">
        <div class="form-check form-check-inline">
          <%= f.check_box :dp, class: "form-check-input" %>
          <%= f.label :dp, class: "form-check-label" %>
        </div>
        <div class="form-check form-check-inline">
          <%= f.check_box :dip, class: "form-check-input" %>
          <%= f.label :dip, class: "form-check-label" %>
        </div>
        <div class="form-check form-check-inline">
          <%= f.check_box :isolation_required, class: "form-check-input" %>
          <%= f.label :isolation_required, class: "form-check-label" %>
        </div>
      </div>

      <div class="mb-3">
        <%= f.label :slope_if_needed, class: "form-label" %>
        <%= f.text_field :slope_if_needed, class: "form-control" %>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :work_package_number, class: "form-label" %>
          <%= f.number_field :work_package_number, class: "form-control" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :test_pack_number, class: "form-label" %>
          <%= f.number_field :test_pack_number, class: "form-control" %>
        </div>
      </div>
    </div>

    <!-- Hold Fields -->
    <div class="row g-3">
      <div class="col-md-6">
        <h5 class="border-bottom pb-2 mb-3"><%= t('.on_hold_status') %></h5>
        <div class="row">
          <div class="col-md-5 mb-3">
            <%= f.label :on_hold_status, class: "form-label" %>
            <%= f.select :on_hold_status, Isometry::ON_HOLD_STATUSES, { include_blank: true }, class: "form-select" %>
          </div>
          <div class="col-md-7 mb-3">
            <%= f.label :on_hold_images, class: "form-label" %>
            <%= f.file_field :on_hold_images, multiple: true, class: "form-control" %>
          </div>
        </div>
        <div class="mb-3">
          <%= f.label :on_hold_comment, class: "form-label" %>
          <%= f.text_area :on_hold_comment, class: "form-control", rows: 4  %>
        </div>
        
        <% if f.object.on_hold_images.attached? %>
          <div class="row g-3">
            <% f.object.on_hold_images.each do |image| %>
              <div class="col-md-6">
                <div class="card h-100">
                  <%= image_tag image, class: "card-img-top", style: "object-fit: cover; height: 150px;" %>
                  <div class="card-footer">
                    <small class="text-muted">
                      <%= number_to_human_size(image.byte_size) %> â€¢ <%= l(image.created_at, format: :short) %>
                    </small>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="col-md-6">
        <h5 class="border-bottom pb-2 mb-3"><%= t('.notes') %></h5>
        <div class="mb-3">
          <%= f.text_area :notes, class: "form-control", rows: 9 %>
        </div>
      </div>
    </div>

    <!-- Image Upload -->
    <div class="row g-3">
      <h5 class="border-bottom pb-2 mb-3"><%= t('.images') %></h5>
      
      <!-- Initial PDF Upload -->
      <div class="col-md-8 mb-3">   
        <div class="row">
          <div class="col-md-8">
            <%= f.label :new_pdf, t('.upload_new_pdf'), class: "form-label" %>
            <%= f.file_field :new_pdf, class: "form-control" %>
          </div>
          
          <div class="col-md-4">
            <%= f.label :new_pdf_qr_position, t('.qr_position'), class: "form-label" %>
            <%= f.select :new_pdf_qr_position, 
                      [
                        [t('.top_left'), "top_left"],
                        [t('.top_right'), "top_right"],
                        [t('.bottom_left'), "bottom_left"],
                        [t('.bottom_right'), "bottom_right"]
                      ],
                      { include_blank: true },
                      class: "form-select" %>
          </div>
        </div>
      </div>

      <!-- Existing PDFs with QR Position Selection -->
      <% if @isometry.persisted? && @isometry.isometry_documents.any? %>
        <div class="col-12">
          <h6 class="mb-3"><%= t('.existing_documents') %></h6>
          
          <%= f.fields_for :isometry_documents do |doc_form| %>
            <div class="card mb-3">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-1 text-center">
                    <i class="bi bi-file-pdf text-danger" style="font-size: 2rem;"></i>
                  </div>
                  <div class="col-md-4">
                    <h6 class="mb-1"><%= doc_form.object.pdf.filename %></h6>
                    <small class="text-muted">
                      <%= number_to_human_size(doc_form.object.pdf.byte_size) %> â€¢
                      <%= l(doc_form.object.pdf.created_at, format: :short) %>
                    </small>
                  </div>
                  <div class="col-md-4">
                    <%= doc_form.select :qr_position,
                      [
                        [t('.top_left'), "top_left"],
                        [t('.top_right'), "top_right"],
                        [t('.bottom_left'), "bottom_left"],
                        [t('.bottom_right'), "bottom_right"]
                      ],
                      { include_blank: true },
                      class: "form-select" %>
                  </div>
                  <div class="col-md-3 text-end">
                    <%= link_to url_for(doc_form.object.pdf), 
                              target: "_blank", 
                              class: "btn btn-outline-primary btn-sm me-2" do %>
                      <i class="bi bi-eye"></i> <%= t('.view') %>
                    <% end %>
                    
                    <%= doc_form.check_box :_destroy, 
                                         class: "btn-check",
                                         id: "delete_doc_#{doc_form.object.id}" %>
                    <%= doc_form.label :_destroy, 
                                     class: "btn btn-outline-danger btn-sm",
                                     for: "delete_doc_#{doc_form.object.id}" do %>
                      <i class="bi bi-trash"></i> <%= t('.delete') %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Submit Buttons -->
    <div class="form-group my-5">
      <%= f.submit class: "btn btn-primary" %>
      <%= link_to t('common.actions.cancel'), :back, class: 'btn btn-secondary' %>
    </div>
  </div>
<% end %>
