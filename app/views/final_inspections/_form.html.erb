<%= form_with(
      model: [@project, @final_inspection],
      local: true,
      class: 'needs-validation',
      id: 'final_inspection_form',
      data: { 
        turbo: true,
        controller: "validation form-changes",
        form_changes_target: "form",
        action: "change->form-changes#checkFormChanges input->form-changes#checkFormChanges"
      }
    ) do |f| %>
  <% if @final_inspection.errors.any? %>
    <div class="alert alert-danger">
      <h6><%= t('.errors.header', count: @final_inspection.errors.count) %></h6>
      <ul>
        <% @final_inspection.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= f.hidden_field :isometry_id, value: @isometry&.id %>

  <div class="row">
    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label t('activerecord.attributes.final_inspection.work_location'), for: :work_location_id, class: 'form-label' %>
        <%= f.collection_select :work_location_id,
                              WorkLocation.all,
                              :id,
                              ->(wl) { wl.location_type ? t("work_locations.types.#{wl.location_type}") : "" },
                              { prompt: t('common.labels.select'), include_blank: false },
                              { class: "form-control" } %>
      </div>

      <div class="mb-3">
        <%= f.label :work_package_number, class: 'form-label' %>
        <div class="input-group" 
             data-controller="work-package-search"
             data-work-package-search-url-value="<%= search_work_packages_project_isometries_path(@project, format: :json) %>"
             data-work-package-search-min-length-value="2">
          <%= f.text_field :work_package_number, 
                          class: 'form-control',
                          data: {
                            work_package_search_target: "input",
                            action: "input->work-package-search#search click@window->work-package-search#clickOutside"
                          } %>
          <div class="dropdown-menu w-100" data-work-package-search-target="results"></div>
        </div>
      </div>
        <div class="mb-3">
      <% if @final_inspection.persisted? && @final_inspection.completed? %>

          <%= f.label :completed, class: 'form-label' %>
          <%= f.text_field :completed, 
                          value: (@final_inspection.completed ? @final_inspection.completed.strftime("%d/%m/%Y %H:%M") : nil),
                          class: 'form-control', 
                          disabled: true %>
        <% end %>

        </div>
    </div>

    <div class="col-md-8">
      <%= render "isometry_details", isometry: @isometry %>

      <%= render 'application/hold_fields', f: f, delete_path: ->(image) { 
        delete_image_project_final_inspection_path(@project, @final_inspection, image_id: image) 
      } %>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-md-6">
     
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <%= f.label :visual_check_status, t('activerecord.attributes.final_inspection.visual_check_status'), class: 'form-label' %>
                <%= f.select :visual_check_status, FinalInspection::VISUAL_STATUSES, { include_blank: false }, class: 'form-control' %>
              </div>
            </div>
            <div class="col-md-6">
              <%= f.label :visual_check_images, t('activerecord.attributes.final_inspection.visual_check_images'), class: 'form-label' %>
              <%= f.file_field :visual_check_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff', class: 'form-control' %>
            </div>
          </div>
          
          <%= render partial: 'application/docuvita_documents', locals: {
            documents: f.object.visual_check_images,
            title: t('.visual_check_images'),
            edit_mode: true,
            model_type: f.object
          } %>

          <%= f.text_area :visual_check_comment, class: 'form-control mt-2', rows: 2,
                          placeholder: t('activerecord.attributes.final_inspection.visual_check_comment') %>
        </div>
      </div>

    </div>
    <div class="col-md-6">

       <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <%= f.label :vt2_check_status, t('activerecord.attributes.final_inspection.vt2_check_status'), class: 'form-label' %>
                <%= f.select :vt2_check_status, FinalInspection::VT2_STATUSES, { include_blank: false }, class: 'form-control' %>
              </div>
            </div>
            <div class="col-md-6">
              <%= f.label :vt2_check_images, t('activerecord.attributes.final_inspection.vt2_check_images'), class: 'form-label' %>
              <%= f.file_field :vt2_check_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff', class: 'form-control' %>
            </div>
          </div>
          
          <%= render partial: 'application/docuvita_documents', locals: { 
            documents: f.object.vt2_check_images, 
            title: t('.vt2_check_images'),
            edit_mode: true,
            model_type: f.object
          } %>

          <%= f.text_area :vt2_check_comment, class: 'form-control mt-2', rows: 2,
                          placeholder: t('activerecord.attributes.final_inspection.vt2_check_comment') %>
        </div>
      </div>

    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-6">
     
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <%= f.label :rt_check_status, t('activerecord.attributes.final_inspection.rt_check_status'), class: 'form-label' %>
                <%= f.select :rt_check_status, FinalInspection::RT_STATUSES, { include_blank: false }, class: 'form-control' %>
              </div>
            </div>
            <div class="col-md-6">
              <%= f.label :rt_check_images, t('activerecord.attributes.final_inspection.rt_check_images'), class: 'form-label' %>
              <%= f.file_field :rt_check_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff', class: 'form-control' %>
            </div>
          </div>
          
          <%= render partial: 'application/docuvita_documents', locals: { 
            documents: f.object.rt_check_images, 
            title: t('.rt_check_images'),
            edit_mode: true,
            model_type: f.object
          } %>

          <%= f.text_area :rt_check_comment, class: 'form-control mt-2', rows: 2,
                          placeholder: t('activerecord.attributes.final_inspection.rt_check_comment') %>
        </div>
      </div>

    </div>
    <div class="col-md-6">

       <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <%= f.label :pt2_check_status, t('activerecord.attributes.final_inspection.pt2_check_status'), class: 'form-label' %>
                <%= f.select :pt2_check_status, FinalInspection::PT2_STATUSES, { include_blank: false }, class: 'form-control' %>
              </div>
            </div>
            <div class="col-md-6">
              <%= f.label :pt2_check_images, t('activerecord.attributes.final_inspection.pt2_check_images'), class: 'form-label' %>
              <%= f.file_field :pt2_check_images, multiple: true, accept: 'image/jpeg,image/png,image/gif,image/bmp,image/tiff', class: 'form-control' %>
            </div>
          </div>
          
          <%= render partial: 'application/docuvita_documents', locals: { 
            documents: f.object.pt2_check_images, 
            title: t('.pt2_check_images'),
            edit_mode: true,
            model_type: f.object
          } %>

          <%= f.text_area :pt2_check_comment, class: 'form-control mt-2', rows: 2,
                          placeholder: t('activerecord.attributes.final_inspection.pt2_check_comment') %>
        </div>
      </div>

    </div>
  </div>

  <div class="row mt-3">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <%= link_to t('common.labels.back'), project_final_inspections_path(@project), class: 'btn btn-primary' %>
          <% if @final_inspection.persisted? && @final_inspection.completed.nil? && !@final_inspection.on_hold? %>
            <%= link_to complete_project_final_inspection_path(@project, @final_inspection),
                      method: :patch,
                      class: 'btn btn-success',
                      data: { 
                        turbo_method: :patch,
                        turbo_confirm: t('common.messages.confirm_complete'),
                        form_changes_target: "completeButton"
                      } do %>
              <i class="bi bi-check-circle"></i> <%= t('common.actions.complete') %>
            <% end %>
          <% end %>
        <%= f.submit t("common.actions.save"), class: "btn btn-primary" %>
      </div>
    </div>
  </div>
<% end %>