<div class="card mb-4" data-controller="pdf-export">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <%= t('progress_tracking.progress_for', type: t("progress_tracking.work_types.#{@progress_plan.work_type}")) %>
      (<%= @progress_plan.revision_last? ? t('progress_tracking.revision_last') : t('progress_tracking.old_revision') %>)
    </h5>
    <div class="d-flex gap-2">
      <button class="btn btn-primary btn-sm" data-action="pdf-export#export">
        <i class="bi bi-file-pdf"></i> <%= t('common.actions.export_to_pdf') %>
      </button>
      <%= link_to project_progress_tracking_index_path(@project, locale: I18n.locale), class: 'btn btn-primary btn-sm' do %>
        <i class="bi bi-arrow-left"></i> <%= t('common.back') %>
      <% end %>
    </div>
  </div>

  <div class="card-body p-5" data-pdf-export-target="content">
    <div class="row mb-4">
      <div class="col-md-12 position-relative">
        <%= image_tag "logo.png", class: "position-absolute top-0 end-0", style: "height: 50px; width: auto;" %>
        <div class="mb-3">
          <strong><%=t('progress_tracking.project_number')%></strong> <%= @project.project_number %><br>
          <strong><%=t('progress_tracking.project_name')%>:</strong> <%= @project.name %>
        </div>
        <% 
          # Calculate total target meters (W9 in Excel)
          # This is the total of all SOLL m values, handling nil values
          total_target_meters = @progress_plan.weekly_progress_entries.sum { |entry| entry.expected_value.to_f }
          
          # Initialize weekly data structure
          weekly_data = {}
          
          # Get all completed items based on work type
          all_completed_items = get_completed_items(@project, @progress_plan.work_type, @progress_plan.start_date)

          # Group by week number
          completed_items = group_completed_items(all_completed_items, @progress_plan.work_type, @progress_plan.start_date)
          
          # Get expected progress from weekly_progress_entries
          expected_progress = @progress_plan.weekly_progress_entries
            .order(:year, :week_number)
            .each_with_object({}) do |entry, hash|
              week_key = "W%02d/%d" % [entry.week_number, entry.year]
              hash[week_key] = entry.expected_value.to_f
            end
            
          # Calculate cumulative totals and percentages
          soll_total = 0  # SOLL m TOTAL
          ist_total = 0   # IST m TOTAL
          
          # Get start and end dates as Date objects for proper week calculations
          start_date = @progress_plan.start_date.to_date
          end_date = @progress_plan.end_date.to_date
          
          # Iterate through each week between start and end dates
          current_date = start_date
          while current_date <= end_date
            week_key = "W%02d/%d" % [current_date.strftime('%V').to_i, current_date.year]
            
            # Calculate SOLL (Expected) values
            soll_meters = expected_progress[week_key] || 0
            soll_total += soll_meters
            # Calculate SOLL % using the Excel formula: =IF($W$9=0,0,SOLL_m_TOTAL/$W$9)
            # where $W$9 is total_target_meters
            soll_percentage = total_target_meters > 0 ? ((soll_total / total_target_meters) * 100).round : 0
            
            # Calculate IST (Actual) values
            ist_meters = completed_items[week_key]&.sum { |item| 
              calculate_ist_value(item, @progress_plan.work_type)
            } || 0
            ist_total += ist_meters
            # Calculate IST % using Excel formula: =IF($W$9=0,0,IST_m_TOTAL/$W$9)
            # where $W$9 is total_target_meters
            ist_percentage = total_target_meters > 0 ? ((ist_total / total_target_meters) * 100).round : 0
            
            weekly_data[week_key] = {
              soll_meters: soll_meters,
              soll_total: soll_total,
              soll_percentage: soll_percentage,
              ist_meters: ist_meters,
              ist_total: ist_total,
              ist_percentage: ist_percentage
            }
            
            # Move to next week
            current_date = current_date + 7.days
          end
        %>
        
        <div class="mb-4 text-center">
          <h4><%= t("progress_tracking.work_types.#{@progress_plan.work_type}") %></h4>
          <p class="text-muted">
            <%= l(@progress_plan.start_date.to_date, format: :long) %> - <%= l(@progress_plan.end_date.to_date, format: :long) %><br>
            <%= t('common.generated_at') %>: <%= l(Time.current, format: :long) %>
          </p>
        </div>
            
    <%
      # Calculate differences for column chart
      differences = weekly_data.values.map do |v|
        soll = v[:soll_percentage]
        ist = v[:ist_percentage]
        diff = ist - soll
        if diff != 0
          {
            y: diff.abs,  # Height of the bar
            low: diff > 0 ? soll : ist,  # Starting point
            color: diff > 0 ? '#90EE90' : '#FFB6C1',  # Green for positive, red for negative
            dataLabels: {
              y: diff > 0 ? -5 : 5  # Adjust label position based on bar direction
            }
          }
        end
      end

      chart_data = {
        xAxis: { categories: weekly_data.keys },
        series: [
          {
            name: "Difference",
            type: 'column',
            data: differences,
            zIndex: 0,
            showInLegend: false,
            pointPadding: 0.2,  # Increase padding to make bars thinner
            groupPadding: 0.2,  # Increase padding to make bars thinner
            borderWidth: 0,
            pointPlacement: 0,
            dataLabels: {
              enabled: true,
              inside: true,
              format: '{point.y}%',  # Show the difference percentage
              style: {
                fontSize: '14px',
                textOutline: 'none',
                fontWeight: 'normal'
              }
            }
          },
          {
            name: "SOLL %",
            type: 'line',
            data: weekly_data.values.map { |v| v[:soll_percentage] },
            zIndex: 1
          },
          {
            name: "IST %",
            type: 'line',
            data: weekly_data.values.map { |v| v[:ist_percentage] },
            zIndex: 1
          }
        ],
        yAxis: {
          title: { text: t('progress_tracking.progress_percentage') },
          min: 0,
          max: 100,
          tickInterval: 10,
          labels: { format: "{value}%" }
        },
        plotOptions: {
          column: {
            grouping: false,
            shadow: false,
            borderWidth: 0
          }
        }
      }
    %>
    <div data-controller="chart" data-chart="<%= chart_data.to_json %>" id="container"></div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Week</th>
            <th>SOLL m</th>
            <th>IST m</th>
            <th>SOLL m TOTAL</th>
            <th>IST m TOTAL</th>
            <th>SOLL %</th>
            <th>IST %</th>
          </tr>
        </thead>
        <tbody>
          <% weekly_data.each do |week, data| %>
            <tr>
              <td><%= week %></td>
              <td>
                <%= form_with(url: project_progress_tracking_path(@project, @progress_plan, locale: I18n.locale),
                    method: :patch,
                    local: true,
                    class: 'edit-expected') do |f| %>
                  <% week_num = week.match(/W(\d+)\/\d+/)[1].to_i %>
                  <% year = week.match(/W\d+\/(\d+)/)[1].to_i %>
                  <%= hidden_field_tag 'weekly_entry[week_number]', week_num %>
                  <%= hidden_field_tag 'weekly_entry[year]', year %>
                  <div class="input-group input-group-sm" style="max-width: 120px;">
                    <%= number_field_tag 'weekly_entry[expected_value]',
                        data[:soll_meters],
                        step: '0.1',
                        class: 'form-control form-control-sm',
                        style: 'width: 50px; min-width: 50px; padding-left: 2px; padding-right: 2px;',
                        onchange: 'this.form.requestSubmit()',
                        disabled: @progress_plan.locked? || !user_signed_in? || !current_user&.admin?,
                        title: @progress_plan.locked? ? t('progress_tracking.locked_error') : (!user_signed_in? || !current_user&.admin? ? t('progress_tracking.admin_only_error') : nil) %>
                    <span class="input-group-text" style="padding: 0 4px;"><%= progress_unit(@progress_plan.work_type) %></span>
                  </div>
                <% end %>
              </td>
              <td><%= number_with_precision(data[:ist_meters], precision: 1) %> <%= progress_unit(@progress_plan.work_type) %></td>
              <td><%= number_with_precision(data[:soll_total], precision: 0) %> <%= progress_unit(@progress_plan.work_type) %></td>
              <td><%= number_with_precision(data[:ist_total], precision: 0) %> <%= progress_unit(@progress_plan.work_type) %></td>
              <td><%= number_with_precision(data[:soll_percentage], precision: 0) %>%</td>
              <td><%= number_with_precision(data[:ist_percentage], precision: 0) %>%</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

  </div>
</div>
